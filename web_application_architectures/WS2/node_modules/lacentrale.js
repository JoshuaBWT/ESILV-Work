var fs = require('fs');
var http = require('http');
var request = require('request');
var cheerio = require('cheerio')
var importJS = require('import_external_js');

var utils = importJS("utils/utils.js");

function getCoteAndRatings(urlC, callback)
{
  request({ url:urlC, method:'GET' },
  function(err, response, body)
  {
    if(err) {
      console.log(err); return;
    }
    var $ = cheerio.load(body);
    var graphdata = "http://lacentrale.fr/" + $("#histo").attr("src");
    var cote = $(".tx12 > span").text();
    console.log("cote : " + cote + ", " + graphdata);
    callback(cote, graphdata);
  });
}

function getYearifWrong($)
{
    request({ url:url, method:'GET' },
    function(err, response, body)
    {

    });
}

getCotesPages =  function(parameters, callback)
{
     try
     {
       //http://www.lacentrale.fr/cote-voitures-renault-avantime--2002-.html
       var options = parameters.title
        .replace(parameters.brand, "")
        .replace(parameters.model, "")
        .trim()
        .replace(/ /g, "+");
       var url = "http://www.lacentrale.fr/cote-voitures";
       url += "-" + parameters.brand;
       url += "-" + parameters.model;
       url += "-" + options;
       url += "-" + parameters.year + "-.html";

      console.log(url);

      request({ url:url, method:'GET' },
      function(err, response, body) {
        if(err) {
          console.log(err); return;
        }
          var result = Array();
          var $ = cheerio.load(body);

          if($('#TabAnnHomeCote').length === 0)
          {
            body = getYearIfWrong(body);
            $ = cheerio.load(body);
          }

          var tableItems = $('#TabAnnHomeCote').children('tr')
          .each(function(index){
            if(index != 0)
            {
              var urlC = "http://lacentrale.fr/" + $(this).children()[1].children[1].attribs["href"];
              var name = $(this).children()[1].children[1].children[0].data;

              //getCoteAndRatings(urlC);

              result.push({"url":urlC, "name":name});
              //if(content.indexOf("tdSD QuotMarque") > -1)
              console.log(name + " : " + urlC);
            }
          });
          callback(result);
          //console.log(body);
      });
     }
     catch(err)
     {
       console.log(err);
     }
};

module.exports = {
  getCotesPages: getCotesPages,
  getCoteAndRatings: getCoteAndRatings
}
