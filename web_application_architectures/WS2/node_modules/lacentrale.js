var fs = require('fs');
var http = require('http');
var request = require('request');
var cheerio = require('cheerio');
var importJS = require('import_external_js');

var utils = importJS("utils/utils.js");

var getCoteAndRatings = function getCoteAndRatings(urlC, callback)
{
  request({ url:urlC, method:'GET' },
  function(err, response, body)
  {
    if(err) {
      console.log(err); return;
    }
    var $ = cheerio.load(body);
    var graphdata = "http://lacentrale.fr/" + $("#histo").attr("src");
    var cote = $(".tx12 > span").text();
    console.log("cote : " + cote + ", " + graphdata);
    callback(cote, graphdata);
  });
}

//si la voiture a la mauvaise annee/pas d'annee sur le bon coin
function getYearIfWrong(body, parameters, callback)
{
  //On tombe sur une page du style http://www.lacentrale.fr/cote-voitures-jeep----.html
    var $ = cheerio.load(body);

    var options = Array();
    var url2 = "";

    options.push(parameters.model);
    parameters.title.split(' ').forEach(function(element, index, array)
    {
      if(element != parameters.brand)
        options.push(element);
    });
    for(var i = 0; i < options.length; i++)
    {
      if($('[href*=' + options[i] + ']').length !== 0)
      {
        url2 = "http://www.lacentrale.fr/" + $('[href*=' + options[i] + ']').attr("href");
        parameters.model = options[i];
      }
    }
    console.log(url2);

    //Après recherche du model de la voiture dans les modèles disponibles on tombe sur une page du style
    //http://www.lacentrale.fr/cote-voitures-jeep-renegade---suv_4x4.html
    //plus qu'a trouver l'année
    request({ url:url2, method:'GET' },
    function(err, response, body)
    {
        var urls = Array();
        console.log("here");
        if(err)
        {
          console.log(err);
          return;
        }
        $ = cheerio.load(body);
        $('[href*=' + "cote-voitures-" + parameters.brand + "-" + parameters.model + ']').each(function ()
        {
          urls.push("http://www.lacentrale.fr/" + $(this).attr("href"));
          //console.log($(this).attr("href"));
        });

        console.log(urls);

        request({ url:urls[0], method:'GET' },
        function(err, response, body)
        {
          //On renvoie la page de resultats avec les options
          callback(body, parameters);
        });
    });
}

function getOptionsList($, callback)
{
  var result = Array();
  $('#TabAnnHomeCote').children('tr')
  .each(function(index){
    if(index != 0)
    {
      var urlC = "http://lacentrale.fr/" + $(this).children()[1].children[1].attribs["href"];
      var name = $(this).children()[1].children[1].children[0].data;

      result.push({ "url": urlC, "name": name });
      console.log(name + " : " + urlC);
    }
  });

  callback(result);
}

var getCotesPages =  function(parameters, callback)
{
     try
     {
       var options = parameters.title
        .replace(parameters.brand, "")
        .replace(parameters.model, "")
        .trim()
        .replace(/ /g, "+");
       var url = "http://www.lacentrale.fr/cote-voitures";
       url += "-" + parameters.brand;
       url += "-" + parameters.model;
       url += "-" + options;
       url += "-" + parameters.year + "-.html";

      console.log(url);

      request({ url:url, method:'GET' },
      function(err, response, body) {
        if(err) {
          console.log(err); return;
        }
          var result = Array();
          var $ = cheerio.load(body);

          if($('#TabAnnHomeCote').length === 0)
          {
            getYearIfWrong(body, parameters, function(nbody, nparameters)
            {
                $ = cheerio.load(nbody);
                parameters = nparameters;
                //console.log(body);
                getOptionsList($, function(resultF)
                {
                    result = resultF;
                    console.log(result);
                    callback(result);
                });
            })
          }
          else
            getOptionsList($, function(resultF)
            {
                result = resultF;
                callback(result);
            });
          //console.log(body);
      });
     }
     catch(err)
     {
       console.log(err);
     }
};

module.exports = {
  getCotesPages: getCotesPages,
  getCoteAndRatings: getCoteAndRatings
}
