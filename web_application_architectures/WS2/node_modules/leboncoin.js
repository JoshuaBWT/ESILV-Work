var fs = require('fs');
var request = require('request');
var cheerio = require('cheerio');

function errortesting(url, trueJson)
{
    var error = {};
    error.haserror = false;
    if(url.indexOf("/voitures/") <= -1 || trueJson.subcat != "voitures")
    {
        console.log("wrong category! (%s,%s)", url, trueJson.subcat);
        error.lbcerror = "wrong offer category! current type("+ trueJson.subcat +")";
        error.haserror = true;
    }
    return error;
}

module.exports = {
    scrapData: function(url, callback)
    {
      request(url, function(error, response, html){
       // First we'll check to make sure no errors occurred when making the request
       if(!error)
       {
           try
           {
               // Next, we'll utilize the cheerio library on the returned html which will essentially give us jQuery functionality
              var $ = cheerio.load(html);

              //Ici on récupère le script contenant les données au format txt.
              var stringedData = $("body").children()[0].children[0].data;

              //On eleve l'initialisation de la variable
              stringedData = stringedData.substr(17, stringedData.length);
              //On transforme le texte en JSON

              var trueJson = JSON.parse(JSON.stringify(eval("(" + stringedData + ")")));
              trueJson.description = $("[itemprop=description]").text();

              var err = errortesting(url, trueJson);

              callback(trueJson, err);
           }
           catch(err)
           {
             console.log(err);
           }
       }
       else {
          console.log(error)
       }
     });
    }
}
